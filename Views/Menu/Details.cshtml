@model KD_Restaurant.ViewModels.MenuDetailViewModel
@using System.Globalization
@using System.Linq

@{
    var item = Model.Item;
    var culture = new CultureInfo("vi-VN");
    var hasSale = item.PriceSale.HasValue && item.PriceSale.Value > 0 && item.PriceSale.Value < item.Price;
    var primaryPrice = hasSale ? item.PriceSale!.Value : item.Price;
    var heroBackgroundStyle = string.IsNullOrWhiteSpace(item.Image)
        ? "background-image: linear-gradient(125deg, rgba(18,18,22,0.9), rgba(55,35,24,0.85));"
        : $"background-image: linear-gradient(125deg, rgba(18,18,22,0.9), rgba(55,35,24,0.85)), url('{item.Image}');";
    var categoryLabel = item.Category?.Title ?? "Ẩm thực KD";
    var ratingHeadline = Model.ReviewCount > 0 ? $"{Model.ReviewCount} đánh giá" : "Chưa có đánh giá";
    var detailHtml = string.IsNullOrWhiteSpace(item.Detail) ? "<p>Thông tin món ăn sẽ được cập nhật.</p>" : item.Detail;
}

@section Styles {
    <style>
        @@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Space+Grotesk:wght@400;500;600&display=swap');

        :root {
            --font-display: 'Playfair Display', serif;
            --font-body: 'Space Grotesk', sans-serif;
            --clay-100: #f7f3ed;
            --clay-300: #e3d7cf;
            --clay-900: #1f1712;
            --gold-500: #f4b942;
            --green-500: #2ecc71;
            --accent-rose: #ff9472;
            --border-soft: rgba(31, 23, 18, 0.08);
        }

        .menu-detail-page {
            font-family: var(--font-body);
            color: var(--clay-900);
            background: linear-gradient(180deg, #fffdf8 0%, #ffffff 45%, #fef4eb 100%);
        }

        .menu-detail-page .card-panel {
            background: #fff;
            border-radius: 1.25rem;
            padding: 2.5rem;
            box-shadow: 0 30px 60px rgba(31, 23, 18, 0.08);
            border: 1px solid var(--border-soft);
        }

        .menu-hero {
            background-size: cover;
            background-position: center;
            padding: 5rem 0 4rem;
            color: #fff5e9;
            position: relative;
        }

        .menu-hero::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.15), transparent 55%);
        }

        .menu-hero .container {
            position: relative;
            z-index: 2;
        }

        .menu-hero__eyebrow {
            text-transform: uppercase;
            letter-spacing: 0.45rem;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .menu-hero h1 {
            font-family: var(--font-display);
            font-size: clamp(2.8rem, 5vw, 4.5rem);
            margin: 1rem 0;
        }

        .menu-hero__lead {
            max-width: 720px;
            font-size: 1.1rem;
            line-height: 1.7;
            color: #ffeede;
        }

        .menu-hero__meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin: 2rem 0;
            font-weight: 500;
        }

        .menu-hero__meta span {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .menu-hero .breadcrumbs {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.95rem;
            color: #ffe0be;
        }

        .menu-hero .breadcrumbs a {
            color: inherit;
            text-decoration: none;
            font-weight: 600;
        }

        .menu-detail__grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2.5rem;
            margin-top: -4rem;
        }

        .menu-gallery__hero {
            position: relative;
            border-radius: 1.25rem;
            overflow: hidden;
        }

        .menu-gallery__hero img {
            width: 100%;
            height: 420px;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .menu-gallery__hero:hover img {
            transform: scale(1.03);
        }

        .menu-gallery__badge {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            backdrop-filter: blur(8px);
            background: rgba(31, 23, 18, 0.6);
            padding: 0.6rem 1.4rem;
            border-radius: 999px;
            color: #fff;
            font-size: 0.85rem;
            letter-spacing: 0.08rem;
            text-transform: uppercase;
        }

        .menu-gallery__thumbs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 0.85rem;
            margin-top: 1.75rem;
        }

        .menu-gallery__thumb {
            border: 1px solid rgba(31, 23, 18, 0.1);
            border-radius: 0.85rem;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }

        .menu-gallery__thumb img {
            width: 100%;
            height: 90px;
            object-fit: cover;
        }

        .menu-gallery__thumb:hover {
            transform: translateY(-4px);
            border-color: var(--gold-500);
        }

        .menu-panel__price {
            display: flex;
            align-items: baseline;
            gap: 1rem;
        }

        .price-current {
            font-size: 2.8rem;
            font-weight: 600;
            font-family: var(--font-display);
        }

        .price-old {
            color: rgba(31, 23, 18, 0.4);
            text-decoration: line-through;
            font-size: 1.1rem;
        }

        .menu-panel__chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
        }

        .menu-panel__chip {
            padding: 0.55rem 1.2rem;
            border-radius: 999px;
            background: rgba(244, 185, 66, 0.15);
            color: #8a5b2d;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .menu-panel__actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        #detail-quantity {
            width: 110px;
            border-radius: 0.85rem;
            border: 1px solid var(--border-soft);
            padding: 0.75rem 1rem;
            font-weight: 600;
        }

        .btn-gradient {
            border: none;
            border-radius: 1rem;
            padding: 0.95rem 2rem;
            background: linear-gradient(120deg, #ff8559, #ff5f6d);
            color: #fff;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08rem;
            box-shadow: 0 18px 35px rgba(255, 111, 102, 0.35);
        }

        .btn-gradient:hover {
            opacity: 0.92;
        }

        .menu-description {
            background: #fff;
            border-radius: 1.25rem;
            padding: 3rem;
            margin-bottom: 2rem;
            box-shadow: 0 30px 60px rgba(31, 23, 18, 0.06);
            border: 1px solid var(--border-soft);
        }

        .review-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 2rem;
            align-items: center;
        }

        .review-score {
            text-align: center;
        }

        .review-score__value {
            font-size: 4rem;
            font-family: var(--font-display);
            line-height: 1;
        }

        .review-score__stars {
            color: var(--gold-500);
            margin: 0.5rem 0;
            font-size: 1.2rem;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.6rem;
        }

        .rating-bar__track {
            flex: 1;
            height: 8px;
            border-radius: 999px;
            background: #f0e6de;
            overflow: hidden;
        }

        .rating-bar__fill {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, #ffb347, #ffcc33);
        }

        .review-card {
            border: 1px solid var(--border-soft);
            border-radius: 1.25rem;
            padding: 1.5rem;
            background: #fff;
            box-shadow: 0 15px 35px rgba(31, 23, 18, 0.05);
        }

        .review-card__head {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .review-avatar {
            width: 56px;
            height: 56px;
            border-radius: 999px;
            background: linear-gradient(135deg, #ffe1c6, #ffc3a0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .review-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0 3rem;
        }

        .review-empty {
            text-align: center;
            padding: 2rem;
            border: 2px dashed rgba(31, 23, 18, 0.15);
            border-radius: 1rem;
        }

        .review-form-card {
            background: linear-gradient(135deg, #fff8f4, #fff);
        }

        .review-form-card input,
        .review-form-card textarea {
            border-radius: 1rem;
            border: 1px solid rgba(31, 23, 18, 0.1);
            padding: 0.85rem 1.1rem;
        }

        .review-form-card textarea {
            min-height: 140px;
        }

        .menu-related__grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .related-card {
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid var(--border-soft);
            background: #fff;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .related-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 45px rgba(31, 23, 18, 0.12);
        }

        .related-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        @@media (max-width: 767px) {
            .menu-detail-page .card-panel {
                padding: 1.75rem;
            }

            .menu-hero__meta {
                gap: 0.75rem;
            }
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
}

<div class="menu-detail-page">
    <section class="menu-hero" style="@heroBackgroundStyle">
        <div class="container">
            <p class="menu-hero__eyebrow">@categoryLabel</p>
            <h1>@item.Title</h1>
            <p class="menu-hero__lead">@item.Description</p>
            <div class="menu-hero__meta">
                <span><i class="fa-solid fa-star"></i>@Model.AverageRating.ToString("0.0")</span>
                <span>@ratingHeadline</span>
                <span><i class="fa-regular fa-clock"></i>@(item.CreatedDate?.ToString("MM/yyyy") ?? "Món mới")</span>
            </div>
            <div class="breadcrumbs">
                <a href="/">Trang chủ</a>
                <span>/</span>
                <a href="/Home/Menu">Thực đơn</a>
                <span>/</span>
                <span>@item.Title</span>
            </div>
        </div>
    </section>

    <section class="container py-5 menu-detail">
        <div class="menu-detail__grid">
            <div class="menu-gallery card-panel">
                <div class="menu-gallery__hero">
                    <img src="@(string.IsNullOrWhiteSpace(item.Image) ? "/assets/img/menu/menu-1.jpg" : item.Image)" alt="Ảnh món ăn">
                    <span class="menu-gallery__badge">Chef's pick</span>
                </div>
                @if (Model.RelatedItems.Any())
                {
                    <div class="menu-gallery__thumbs">
                        @foreach (var related in Model.RelatedItems.Take(4))
                        {
                            <div class="menu-gallery__thumb" data-image="@related.Image">
                                <img src="@related.Image" alt="@related.Title">
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="menu-panel card-panel">
                <div class="menu-panel__price">
                    <span class="price-current">@string.Format(culture, "{0:C0}", primaryPrice)</span>
                    @if (hasSale)
                    {
                        <span class="price-old">@string.Format(culture, "{0:C0}", item.Price)</span>
                    }
                </div>
                <p class="text-muted mb-3">Giá đã gồm phí phục vụ tại bàn. Giảm giá hiển thị áp dụng cho khách đặt online.</p>

                <div class="d-flex align-items-center gap-3 mb-4">
                    <span class="badge text-bg-warning text-dark py-2 px-3">@categoryLabel</span>
                    <span class="badge text-bg-light text-muted py-2 px-3">@item.Quantity suất khả dụng</span>
                </div>

                <div class="menu-panel__chips mb-4">
                    <span class="menu-panel__chip">Độ yêu thích: @item.Star/5 ⭐</span>
                    <span class="menu-panel__chip">Bếp trưởng KD</span>
                    @* <span class="menu-panel__chip">Giao trong 30 phút</span> *@
                </div>

                <div class="menu-panel__actions">
                    <label class="fw-semibold" for="detail-quantity">Số lượng</label>
                    <input type="number" id="detail-quantity" value="1" min="1" max="@(Math.Max(item.Quantity, 10))">
                    <button type="button" class="btn-gradient js-add-to-cart" data-id="@item.IdMenuItem">Thêm vào giỏ</button>
                </div>

                <div class="mt-4 small text-muted">
                    Đặt món trực tuyến để nhận xác nhận ngay và tích điểm thành viên. Mọi đánh giá sẽ được duyệt trong vòng 24 giờ làm việc.
                </div>
            </div>
        </div>
    </section>

    <section class="container pb-5">
        <div class="menu-description">
            @Html.Raw(detailHtml)
        </div>
    </section>

    <section class="container pb-5">
        <div class="card-panel review-summary">
            <div class="review-score">
                <p class="text-uppercase fw-semibold text-muted mb-2">Đánh giá trung bình</p>
                <div class="review-score__value">@Model.AverageRating.ToString("0.0")</div>
                <div class="review-score__stars">
                    @for (var i = 1; i <= 5; i++)
                    {
                        var active = Model.AverageRating >= i - 0.25;
                        <i class="fa-solid fa-star @(active ? "" : "text-secondary")"></i>
                    }
                </div>
                <p class="mb-0 text-muted">@ratingHeadline</p>
            </div>
            <div>
                @foreach (var bucket in Model.RatingBreakdown)
                {
                    <div class="rating-bar">
                        <span>@bucket.Star<i class="fa-solid fa-star ms-1 text-warning"></i></span>
                        <div class="rating-bar__track">
                            <span class="rating-bar__fill" style="width:@bucket.Percentage%"></span>
                        </div>
                        <span class="rating-bar__count">@bucket.Count</span>
                    </div>
                }
            </div>
        </div>

        <div class="mt-4 card-panel">
            <h3 class="mb-3">Cảm nhận thực khách</h3>
            <div class="review-list">
                @if (Model.Reviews.Any())
                {
                    foreach (var review in Model.Reviews)
                    {
                        <div class="review-card">
                            <div class="review-card__head">
                                @if (!string.IsNullOrWhiteSpace(review.Image))
                                {
                                    <img src="@review.Image" alt="@review.DisplayName" class="review-avatar object-fit-cover">
                                }
                                else
                                {
                                    <div class="review-avatar">@review.Initials</div>
                                }
                                <div>
                                    <strong>@review.DisplayName</strong>
                                    <p class="mb-0 text-muted small">@review.CreatedDate?.ToString("dd/MM/yyyy")</p>
                                </div>
                            </div>
                            <div class="mt-3 text-warning">
                                @for (var star = 0; star < review.Rating; star++)
                                {
                                    <i class="fa-solid fa-star"></i>
                                }
                            </div>
                            <p class="mt-2">@review.Detail</p>
                        </div>
                    }
                }
                else
                {
                    <div class="review-empty">
                        <p class="mb-1 fw-semibold">Chưa có đánh giá nào</p>
                        <p class="text-muted mb-0">Hãy là người đầu tiên chia sẻ cảm nhận của bạn nhé.</p>
                    </div>
                }
            </div>

            <div class="review-form-card card-panel mt-4">
                <h4 class="mb-3">Gửi đánh giá của bạn</h4>
                <div class="row g-3" id="review-form">
                    <input type="hidden" id="review-menuId" value="@item.IdMenuItem" />
                    <div class="col-md-4">
                        <label class="form-label">Họ và tên</label>
                        <input type="text" class="form-control" id="review-name" placeholder="Nguyễn Văn A">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Số điện thoại</label>
                        <input type="text" class="form-control" id="review-phone" placeholder="090 xxx xxxx">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Điểm hài lòng (1-5)</label>
                        <input type="number" min="1" max="5" class="form-control" id="review-rating" value="5">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Chia sẻ trải nghiệm</label>
                        <textarea class="form-control" id="review-message" placeholder="Hương vị, phong cách phục vụ, gợi ý kết hợp..."></textarea>
                    </div>
                    <div class="col-12 d-flex justify-content-between align-items-center">
                        <small class="text-muted">Đánh giá sẽ được duyệt để đảm bảo tiêu chuẩn cộng đồng.</small>
                        <button type="button" class="btn-gradient" id="review-submit">Gửi đánh giá</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    @if (Model.RelatedItems.Any())
    {
        <section class="container pb-5 menu-related">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="fw-semibold">Món ăn gợi ý</h3>
                <a href="/Home/Menu" class="text-decoration-none fw-semibold">Xem toàn bộ thực đơn →</a>
            </div>
            <div class="menu-related__grid">
                @foreach (var related in Model.RelatedItems)
                {
                    <a class="related-card text-decoration-none text-dark" href="/menu/@(related.Alias ?? "mon-an")-@(related.IdMenuItem).html">
                        <img src="@related.Image" alt="@related.Title">
                        <div class="p-3">
                            <h5 class="fw-semibold">@related.Title</h5>
                            <p class="text-muted small">@related.Description</p>
                            <span class="fw-bold">@string.Format(culture, "{0:C0}", related.PriceSale ?? related.Price)</span>
                        </div>
                    </a>
                }
            </div>
        </section>
    }
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        $(function () {
            $('.js-add-to-cart').on('click', function () {
                const id = $(this).data('id');
                const quantity = $('#detail-quantity').val();
                $.post('/Cart/AddToCart', { id, quantity })
                    .done(function (res) {
                        if (res.success) {
                            toastr.success(res.message || 'Đã thêm vào giỏ hàng.');
                        } else {
                            toastr.error(res.message || 'Không thể thêm vào giỏ.');
                        }
                    })
                    .fail(function () {
                        toastr.error('Không thể kết nối tới hệ thống.');
                    });
            });

            $('#review-submit').on('click', function (e) {
                e.preventDefault();
                const payload = {
                    menuid: $('#review-menuId').val(),
                    name: $('#review-name').val(),
                    phone: $('#review-phone').val(),
                    rating: $('#review-rating').val(),
                    message: $('#review-message').val()
                };

                $.post('/Menu/CreateReview', payload)
                    .done(function (result) {
                        if (result.status) {
                            $('#review-name, #review-phone, #review-rating, #review-message').val('');
                            toastr.success(result.message || 'Gửi thành công, xin chờ phê duyệt.');
                        } else {
                            toastr.warning(result.message || 'Vui lòng kiểm tra lại thông tin.');
                        }
                    })
                    .fail(function () {
                        toastr.error('Có lỗi xảy ra, vui lòng thử lại.');
                    });
            });

            $('.menu-gallery__thumb').on('click', function () {
                const src = $(this).data('image');
                if (src) {
                    $('.menu-gallery__hero img').attr('src', src);
                }
            });
        });
    </script>
}
