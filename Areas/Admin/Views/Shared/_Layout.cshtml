@using System
@using System.Collections.Generic
@using System.Linq
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject KD_Restaurant.Models.KDContext DbContext
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Dashboard - NiceAdmin Bootstrap Template</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

<!-- Favicons -->
<link href="/admin/assets/img/favicon.png" rel="icon">
<link href="/admin/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

<!-- Google Fonts -->
<link href="https://fonts.gstatic.com" rel="preconnect">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

<!-- Vendor CSS Files -->
<link href="/admin/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="/admin/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
<link href="/admin/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
<link href="/admin/assets/vendor/quill/quill.snow.css" rel="stylesheet">
<link href="/admin/assets/vendor/quill/quill.bubble.css" rel="stylesheet">
<link href="/admin/assets/vendor/remixicon/remixicon.css" rel="stylesheet">
<link href="/admin/assets/vendor/simple-datatables/style.css" rel="stylesheet">

<!-- FontAwesome 6 (nếu dùng icon FA) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<!-- Template Main CSS File -->
<link href="/admin/assets/css/style.css" rel="stylesheet">

@RenderSection("Styles", required: false)

  <!-- =======================================================
  * Template Name: NiceAdmin - v2.4.1
  * Template URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center">
        <img src="/admin/assets/img/logo.png" alt="">
        <span class="d-none d-lg-block">KD RESTAURANT</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><!-- End Logo -->

    <div class="search-bar">
      <form class="search-form d-flex align-items-center" method="POST" action="#">
        <input type="text" name="query" placeholder="Search" title="Enter search keyword">
        <button type="submit" title="Search"><i class="bi bi-search"></i></button>
      </form>
    </div><!-- End Search Bar -->

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">

        <li class="nav-item d-block d-lg-none">
          <a class="nav-link nav-icon search-bar-toggle " href="#">
            <i class="bi bi-search"></i>
          </a>
        </li><!-- End Search Icon-->

        <li class="nav-item dropdown">

          <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell"></i>
            <span class="badge bg-primary badge-number">4</span>
          </a><!-- End Notification Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications">
            <li class="dropdown-header">
              You have 4 new notifications
              <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">View all</span></a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="notification-item">
              <i class="bi bi-exclamation-circle text-warning"></i>
              <div>
                <h4>Lorem Ipsum</h4>
                <p>Quae dolorem earum veritatis oditseno</p>
                <p>30 min. ago</p>
              </div>
            </li>

            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="notification-item">
              <i class="bi bi-x-circle text-danger"></i>
              <div>
                <h4>Atque rerum nesciunt</h4>
                <p>Quae dolorem earum veritatis oditseno</p>
                <p>1 hr. ago</p>
              </div>
            </li>

            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="notification-item">
              <i class="bi bi-check-circle text-success"></i>
              <div>
                <h4>Sit rerum fuga</h4>
                <p>Quae dolorem earum veritatis oditseno</p>
                <p>2 hrs. ago</p>
              </div>
            </li>

            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="notification-item">
              <i class="bi bi-info-circle text-primary"></i>
              <div>
                <h4>Dicta reprehenderit</h4>
                <p>Quae dolorem earum veritatis oditseno</p>
                <p>4 hrs. ago</p>
              </div>
            </li>

            <li>
              <hr class="dropdown-divider">
            </li>
            <li class="dropdown-footer">
              <a href="#">Show all notifications</a>
            </li>

          </ul><!-- End Notification Dropdown Items -->

        </li><!-- End Notification Nav -->

        <li class="nav-item dropdown">

          <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-chat-left-text"></i>
            <span class="badge bg-success badge-number">3</span>
          </a><!-- End Messages Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow messages">
            <li class="dropdown-header">
              You have 3 new messages
              <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">View all</span></a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="message-item">
              <a href="#">
                <img src="/admin/assets/img/messages-1.jpg" alt="" class="rounded-circle">
                <div>
                  <h4>Maria Hudson</h4>
                  <p>Velit asperiores et ducimus soluta repudiandae labore officia est ut...</p>
                  <p>4 hrs. ago</p>
                </div>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="message-item">
              <a href="#">
                <img src="/admin/assets/img/messages-2.jpg" alt="" class="rounded-circle">
                <div>
                  <h4>Anna Nelson</h4>
                  <p>Velit asperiores et ducimus soluta repudiandae labore officia est ut...</p>
                  <p>6 hrs. ago</p>
                </div>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="message-item">
              <a href="#">
                <img src="/admin/assets/img/messages-3.jpg" alt="" class="rounded-circle">
                <div>
                  <h4>David Muldon</h4>
                  <p>Velit asperiores et ducimus soluta repudiandae labore officia est ut...</p>
                  <p>8 hrs. ago</p>
                </div>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li class="dropdown-footer">
              <a href="#">Show all messages</a>
            </li>

          </ul><!-- End Messages Dropdown Items -->

        </li><!-- End Messages Nav -->

        <li class="nav-item dropdown pe-3">
            @{
              var adminDisplayName = User.Identity?.Name ?? "Tài khoản";
              string? adminAvatar = null;
              var idClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
              var roleClaim = User.FindFirstValue(ClaimTypes.Role);
              if (int.TryParse(idClaim, out var adminId))
              {
                var adminUser = DbContext.tblUser
                  .AsNoTracking()
                  .FirstOrDefault(u => u.IdUser == adminId);
                if (adminUser != null)
                {
                  var composed = string.Join(" ", new[] { adminUser.LastName, adminUser.FirstName }
                    .Where(part => !string.IsNullOrWhiteSpace(part)));
                  adminDisplayName = string.IsNullOrWhiteSpace(composed) ? adminUser.UserName : composed;
                  adminAvatar = adminUser.Avatar;
                }
              }
              var adminInitial = !string.IsNullOrWhiteSpace(adminDisplayName)
                ? adminDisplayName.Substring(0, 1).ToUpper()
                : "?";

              var permissionSet = string.IsNullOrWhiteSpace(roleClaim)
                ? new HashSet<string>(StringComparer.OrdinalIgnoreCase)
                : DbContext.tblRolePermission
                  .AsNoTracking()
                  .Where(rp => rp.IsAllowed && rp.Role != null && rp.Role.RoleName == roleClaim)
                  .Select(rp => rp.PermissionKey)
                  .ToHashSet(StringComparer.OrdinalIgnoreCase);

              bool HasPermission(string key) => permissionSet.Contains(key);
              var canDashboard = HasPermission(KD_Restaurant.Utilities.PermissionKeys.Dashboard);
              var canMenuStructure = HasPermission(KD_Restaurant.Utilities.PermissionKeys.MenuStructure);
              var canMenuCatalog = HasPermission(KD_Restaurant.Utilities.PermissionKeys.MenuCatalog);
              var canMenuReview = HasPermission(KD_Restaurant.Utilities.PermissionKeys.MenuReviewManagement);
              var canContact = HasPermission(KD_Restaurant.Utilities.PermissionKeys.ContactManagement);
              var canBooking = HasPermission(KD_Restaurant.Utilities.PermissionKeys.BookingManagement);
              var canOrders = HasPermission(KD_Restaurant.Utilities.PermissionKeys.OrderManagement);
              var canTables = HasPermission(KD_Restaurant.Utilities.PermissionKeys.TableManagement);
              var canSlider = HasPermission(KD_Restaurant.Utilities.PermissionKeys.SliderManagement);
              var canCustomer = HasPermission(KD_Restaurant.Utilities.PermissionKeys.CustomerManagement);
              var canEmployee = HasPermission(KD_Restaurant.Utilities.PermissionKeys.EmployeeManagement);
              var canRole = HasPermission(KD_Restaurant.Utilities.PermissionKeys.RoleManagement);
              var canBranch = HasPermission(KD_Restaurant.Utilities.PermissionKeys.BranchManagement);
              var canRestaurantInfo = HasPermission(KD_Restaurant.Utilities.PermissionKeys.RestaurantSettings);
            }

          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            @if (!string.IsNullOrWhiteSpace(adminAvatar))
            {
                <img src="@adminAvatar" alt="Avatar" class="rounded-circle admin-avatar-img">
            }
            else
            {
                <span class="rounded-circle admin-avatar-fallback">@adminInitial</span>
            }
            <span class="d-none d-md-block dropdown-toggle ps-2">@adminDisplayName</span>
          </a><!-- End Profile Image Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
              <h6>@adminDisplayName</h6>
              <span>Quản trị viên KD Restaurant</span>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li>
              <a class="dropdown-item d-flex align-items-center" href="/Account/Profile">
                <i class="bi bi-person"></i>
                <span>Thông tin cá nhân</span>
              </a>
            </li>
            <li>
              <a class="dropdown-item d-flex align-items-center" href="/">
                <i class="bi bi-arrow-return-left"></i>
                <span>Quay lại website</span>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            <li>
              <form asp-area="" asp-controller="Account" asp-action="Logout" method="post" class="dropdown-item d-flex align-items-center gap-2">
                @Html.AntiForgeryToken()
                <i class="bi bi-box-arrow-right text-danger"></i>
                <button type="submit" class="btn btn-link p-0 text-danger fw-semibold">Đăng xuất</button>
              </form>
            </li>

          </ul><!-- End Profile Dropdown Items -->
        </li><!-- End Profile Nav -->

      </ul>
    </nav><!-- End Icons Navigation -->

  </header><!-- End Header -->

 <!-- ======= Sidebar ======= -->
 <aside id="sidebar" class=" sidebar">
   <ul class="accordion sidebar-nav" id="accordionExample">
     @if (canDashboard)
     {
       <li class="nav-item">
       <a class="nav-link collapsed" href="/admin/home"><i class="fa-solid fa-bars me-2 fs-5"></i> Thống kê</a>
       </li>
     }

     @if (canMenuStructure)
     {
       <li class="nav-item">
       <button class="accordion-button collapsed nav-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false">
         <i class="fa-solid fa-bars me-2 fs-5"></i> Quản lý menu
       </button>
       <ul id="collapseOne" class="nav-item accordion-collapse collapse" data-bs-parent="#accordionExample">
         <li class="nav-item">
           <a class="ps-0 nav-link collapsed" href="/Admin/Menu"><i class="me-2"></i>Danh sách</a>
         </li>
         <li class="nav-item">
           <a class="ps-0 nav-link collapsed" href="/Admin/Menu/Create"><i class="me-2"></i>Thêm mới</a>
         </li>
       </ul>
       </li>
     }

     @if (canTables || canBooking)
     {
       <li class="nav-item">
       <button class="accordion-button collapsed nav-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false">
         <i class="fa-solid fa-sliders me-2 fs-5"></i>Đặt bàn
       </button>
       <ul id="collapseTwo" class="nav-item accordion-collapse collapse" data-bs-parent="#accordionExample">
         @if (canTables)
         {
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/Tables"><i class="me-2"></i>Sơ đồ bàn</a>
           </li>
         }
         @if (canBooking)
         {
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/Bookings"><i class="me-2"></i>Danh sách lịch đặt bàn</a>
           </li>
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" asp-area="Admin" asp-controller="Bookings" asp-action="History"><i class="me-2"></i>Lịch sử đặt bàn</a>
           </li>
         }
       </ul>
       </li>
     }

     @if (canOrders)
     {
       <li class="nav-item">
       <button class="accordion-button collapsed nav-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false">
         <i class="fa-solid fa-book-bookmark me-2 fs-5"></i> Hoá đơn
       </button>
       <ul id="collapseThree" class="nav-item accordion-collapse collapse" data-bs-parent="#accordionExample">
         <li class="nav-item">
           <a class="ps-0 nav-link collapsed" asp-area="Admin" asp-controller="Book" asp-action="Index"><i class="me-2"></i>Đơn hiện tại</a>
         </li>
         <li class="nav-item">
           <a class="ps-0 nav-link collapsed" asp-area="Admin" asp-controller="Book" asp-action="History"><i class="me-2"></i>Lịch sử hoá đơn</a>
         </li>
       </ul>
       </li>
     }

     @if (canMenuCatalog || canMenuReview)
     {
       <li class="nav-item">
       <button class="accordion-button collapsed nav-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false">
         <i class="fa-solid fa-feather fs-5 me-2"></i> Quản lý thực đơn
       </button>
       <ul id="collapseFour" class="nav-item accordion-collapse collapse" data-bs-parent="#accordionExample">
         @if (canMenuCatalog)
         {
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/MenuItem"><i class="me-2"></i>Danh sách món ăn</a>
           </li>
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/MenuItem/Create"><i class="me-2"></i>Thêm món ăn</a>
           </li>
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/MenuCategory"><i class="me-2"></i>Danh mục món ăn</a>
           </li>
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/MenuCategory#category-create"><i class="me-2"></i>Thêm danh mục</a>
           </li>
         }
         @if (canMenuReview)
         {
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/MenuReview"><i class="me-2"></i>Đánh giá món ăn</a>
           </li>
         }
       </ul>
       </li>
     }

     @* @if (canBranch || canRestaurantInfo)
     {
       <li class="nav-item">
       <button class="accordion-button collapsed nav-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSettings" aria-expanded="false">
         <i class="fa-solid fa-gears fs-5 me-2"></i> Thiết lập nhà hàng
       </button>
       <ul id="collapseSettings" class="nav-item accordion-collapse collapse" data-bs-parent="#accordionExample">
         @if (canBranch)
         {
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/Branch"><i class="me-2"></i>Thiết lập cơ sở</a>
           </li>
         }
         @if (canRestaurantInfo)
         {
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/RestaurantInfo"><i class="me-2"></i>Thông tin nhà hàng</a>
           </li>
         }
       </ul>
       </li>
     } *@

     @if (canEmployee || canRole)
     {
       <li class="nav-item">
       <button class="accordion-button collapsed nav-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false">
         <i class="fa-solid fa-pen me-2 fs-6"></i> Quản lý nhân viên
       </button>
       <ul id="collapseFive" class="nav-item accordion-collapse collapse" data-bs-parent="#accordionExample">
         @if (canEmployee)
         {
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" asp-area="Admin" asp-controller="Employee" asp-action="Index"><i class="me-2"></i>Danh sách nhân viên</a>
           </li>
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" asp-area="Admin" asp-controller="Employee" asp-action="Create"><i class="me-2"></i>Thêm nhân viên</a>
           </li>
         }
         @if (canRole)
         {
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" asp-area="Admin" asp-controller="Role" asp-action="Index"><i class="me-2"></i>Phân quyền & vai trò</a>
           </li>
         }
       </ul>
       </li>
     }

     @if (canCustomer)
     {
       <li class="nav-item">
       <button class="accordion-button collapsed nav-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSeven" aria-expanded="false">
         <i class="fa-brands fa-blogger fs-5 me-2 fw-blod"></i> Quản lý khách hàng
       </button>
       <ul id="collapseSeven" class="nav-item accordion-collapse collapse" data-bs-parent="#accordionExample">
         <li class="nav-item">
           <a class="ps-0 nav-link collapsed" href="/Admin/Customer"><i class="me-2"></i>Danh sách khách hàng</a>
         </li>
         <li class="nav-item">
           <a class="ps-0 nav-link collapsed" href="/Admin/Customer/Create"><i class="me-2"></i>Thêm khách hàng</a>
         </li>
       </ul>
       </li>
     }

     @if (canContact)
     {
       <li class="nav-item">
         <a class="nav-link collapsed" href="/Admin/Contact">
           <i class="fa-solid fa-envelope-open-text me-2 fs-5"></i> Liên hệ khách hàng
         </a>
       </li>
     }

     @if (canSlider)
     {
       <li class="nav-item">
       <button class="accordion-button collapsed nav-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEight" aria-expanded="false">
         <i class="fa-solid fa-gear me-2 fs-5"></i> Quản lý slider
       </button>
       <ul id="collapseEight" class="nav-item accordion-collapse collapse" data-bs-parent="#accordionExample">
         <li class="nav-item">
           <a class="ps-0 nav-link collapsed" href="/Admin/Slider"><i class="me-2"></i>Danh sách</a>
         </li>
         <li class="nav-item">
           <a class="ps-0 nav-link collapsed" href="/Admin/Slider/Create"><i class="me-2"></i>Thêm mới</a>
         </li>
       </ul>
       </li>
     }

     @if (canBranch || canRestaurantInfo)
     {
       <li class="nav-item">
       <button class="accordion-button collapsed nav-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSettings" aria-expanded="false">
         <i class="fa-solid fa-gears fs-5 me-2"></i> Thiết lập nhà hàng
       </button>
       <ul id="collapseSettings" class="nav-item accordion-collapse collapse" data-bs-parent="#accordionExample">
         @if (canBranch)
         {
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/Branch"><i class="me-2"></i>Thiết lập cơ sở</a>
           </li>
         }
         @if (canRestaurantInfo)
         {
           <li class="nav-item">
             <a class="ps-0 nav-link collapsed" href="/Admin/RestaurantInfo"><i class="me-2"></i>Thông tin nhà hàng</a>
           </li>
         }
       </ul>
       </li>
     }
     
   </ul>
   </aside><!-- End Sidebar-->

  <main id="main" class="main">

@RenderBody()

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Copyright <strong><span>NiceAdmin</span></strong>. All Rights Reserved
    </div>
    <div class="credits">
      <!-- All the links in the footer should remain intact. -->
      <!-- You can delete the links only if you purchased the pro version. -->
      <!-- Licensing information: https://bootstrapmade.com/license/ -->
      <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/ -->
      Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

    <style>
    .admin-avatar-img {
      width: 38px;
      height: 38px;
      object-fit: cover;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.4);
    }

    .admin-avatar-fallback {
      width: 38px;
      height: 38px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      background: linear-gradient(135deg, #f8d67a, #f3a953);
      color: #3e1f00;
    }

    .profile .dropdown-item form,
    .profile .dropdown-item button,
    .profile form.dropdown-item {
      width: 100%;
    }

    .profile form.dropdown-item button {
      text-align: left;
    }
    </style>

<!-- Vendor JS Files -->
<script src="/admin/assets/vendor/apexcharts/apexcharts.min.js"></script>
<script src="/admin/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/admin/assets/vendor/chart.js/chart.min.js"></script>
<script src="/admin/assets/vendor/echarts/echarts.min.js"></script>
<script src="/admin/assets/vendor/quill/quill.min.js"></script>
<script src="/admin/assets/vendor/simple-datatables/simple-datatables.js"></script>
<script src="/admin/assets/vendor/tinymce/tinymce.min.js"></script>
<script src="/admin/assets/vendor/php-email-form/validate.js"></script>

<!-- Template Main JS File -->
<script src="/admin/assets/js/main.js"></script>
@RenderSection("Scripts", required: false)

</body>

</html>