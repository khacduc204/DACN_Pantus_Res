@using KD_Restaurant.ViewModels
@model CurrentOrderListViewModel
@{
    ViewData["Title"] = Model.Title;
    var counters = Model.TabCounters ?? new Dictionary<string, int>();
    var activeTab = string.IsNullOrWhiteSpace(Model.ActiveTab) ? "all" : Model.ActiveTab;
    var orders = Model.Orders ?? new List<CurrentOrderSummaryViewModel>();
    int Count(string key) => counters.TryGetValue(key, out var value) ? value : 0;
    string FormatCurrency(int amount) => string.Format("{0:N0} ₫", amount);
}

<div class="pagetitle">
    <h1>@Model.Title</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Home" asp-action="Index">Dashboard</a></li>
            <li class="breadcrumb-item active">@Model.Title</li>
        </ol>
    </nav>
</div>

<section class="section">
    <div class="card history-card shadow-sm">
        <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between gap-3 align-items-center mb-4">
                <div>
                    <h5 class="mb-1">@Model.Title</h5>
                    <p class="text-muted mb-0">@Model.Description</p>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <a class="btn btn-dark" asp-area="Admin" asp-controller="Book" asp-action="Index">
                        <i class="bi bi-receipt-cutoff me-1"></i>Đơn hiện tại
                    </a>
                    <a class="btn btn-primary" asp-area="Admin" asp-controller="Bookings" asp-action="Index">
                        <i class="bi bi-plus-circle me-1"></i>Tạo đơn mới
                    </a>
                </div>
            </div>

            <ul class="nav nav-pills history-tabs mb-4" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "all" ? "active" : null)" type="button" data-history-tab="all">
                        Tất cả <span class="badge bg-light text-dark">@Count("all")</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "pending" ? "active" : null)" type="button" data-history-tab="pending">
                        Chờ xác nhận <span class="badge bg-light text-dark">@Count("pending")</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "paid" ? "active" : null)" type="button" data-history-tab="paid">
                        Đã thanh toán <span class="badge bg-light text-dark">@Count("paid")</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "cancelled" ? "active" : null)" type="button" data-history-tab="cancelled">
                        Đã huỷ <span class="badge bg-light text-dark">@Count("cancelled")</span>
                    </button>
                </li>
            </ul>

            <div class="row g-3 align-items-center mb-3">
                <div class="col-sm-4">
                    <label class="form-label text-muted mb-1">Hiển thị</label>
                    <select class="form-select" id="invoicePageSize">
                        <option value="5" selected>5 dòng</option>
                        <option value="10">10 dòng</option>
                        <option value="25">25 dòng</option>
                        <option value="50">50 dòng</option>
                    </select>
                </div>
                <div class="col-sm-8">
                    <label class="form-label text-muted mb-1">Tìm kiếm</label>
                    <input type="search" class="form-control" id="invoiceSearch" value="@Model.SearchTerm" placeholder="Nhập từ khoá: tên khách, SĐT, bàn..." />
                </div>
            </div>

            <div class="table-responsive">
                <table class="table align-middle" id="invoiceHistoryTable">
                    <thead>
                        <tr>
                            <th>Thời gian thanh toán</th>
                            <th>Tham chiếu</th>
                            <th>Thu ngân</th>
                            <th>Khu vực/Bàn</th>
                            <th>Thông tin KH</th>
                            <th>Thanh toán</th>
                            <th class="text-end">Tổng tiền</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (orders.Any())
                        {
                            foreach (var order in orders)
                            {
                                var searchBlob = string.Join(" ", new[]
                                {
                                    order.CustomerName,
                                    order.CustomerPhone,
                                    order.TableName,
                                    order.BranchName,
                                    order.ReferenceCode
                                }.Where(s => !string.IsNullOrWhiteSpace(s))).ToLowerInvariant();
                                var detailUrl = Url.Action("CurrentOrder", "Bookings", new { area = "Admin", bookingId = order.BookingId });
                                var invoiceUrl = Url.Action("Invoice", "Bookings", new { area = "Admin", bookingId = order.BookingId });
                                <tr data-history-row data-status="@order.StatusKey" data-search="@searchBlob">
                                    <td>
                                        <div class="fw-semibold">@(order.PaymentTime?.ToString("dd/MM/yyyy HH:mm") ?? "Chưa thanh toán")</div>
                                        <div class="text-muted small">@order.TimeIn?.ToString("HH:mm") - @order.TimeOut?.ToString("HH:mm")</div>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">@order.ReferenceCode</div>
                                        <a class="small" href="@detailUrl">Mở đơn</a>
                                    </td>
                                    <td>@(string.IsNullOrWhiteSpace(order.CashierName) ? "—" : order.CashierName)</td>
                                    <td>
                                        <div class="fw-semibold">@(order.TableName ?? "Chưa xếp")</div>
                                        <div class="text-muted small">@order.BranchName</div>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">@order.CustomerName</div>
                                        <div class="text-muted small">@order.CustomerPhone</div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark d-block mb-1">@(!string.IsNullOrWhiteSpace(order.PaymentMethod) ? order.PaymentMethod : "Chưa xác định")</span>
                                        <span class="badge @order.StatusBadgeClass">@order.StatusName</span>
                                        @if (order.StatusKey == "cancelled")
                                        {
                                            <div class="text-muted small mt-1">
                                                @if (order.CancelledAt.HasValue)
                                                {
                                                    <div>Huỷ @(order.CancelledAt?.ToString("dd/MM HH:mm"))</div>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(order.CancelledByName))
                                                {
                                                    <div>Bởi @order.CancelledByName</div>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(order.CancellationReason))
                                                {
                                                    <div>Lý do: @order.CancellationReason</div>
                                                }
                                            </div>
                                        }
                                    </td>
                                    <td class="text-end fw-semibold">@FormatCurrency(order.TotalAmount)</td>
                                    <td class="text-end">
                                        <a class="btn btn-sm btn-outline-primary" href="@invoiceUrl">
                                            <i class="bi bi-eye"></i> Chi tiết
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">Chưa có dữ liệu.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="text-center text-muted py-4 d-none" data-empty-state>
                Không tìm thấy hoá đơn nào phù hợp với bộ lọc.
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        (() => {
            const tabs = document.querySelectorAll('[data-history-tab]');
            const rows = Array.from(document.querySelectorAll('[data-history-row]'));
            const pageSizeSelect = document.getElementById('invoicePageSize');
            const searchInput = document.getElementById('invoiceSearch');
            const emptyState = document.querySelector('[data-empty-state]');
            let activeTab = '@activeTab';
            let searchTimer;

            const applyFilters = () => {
                const size = parseInt(pageSizeSelect?.value ?? rows.length, 10) || rows.length;
                const term = (searchInput?.value ?? '').trim().toLowerCase();
                let visible = 0;

                rows.forEach(row => {
                    const matchesTab = activeTab === 'all' || row.dataset.status === activeTab;
                    const matchesSearch = !term || (row.dataset.search ?? '').includes(term);
                    if (matchesTab && matchesSearch) {
                        visible += 1;
                        const withinPage = visible <= size;
                        row.classList.toggle('d-none', !withinPage);
                    } else {
                        row.classList.add('d-none');
                    }
                });

                if (emptyState) {
                    emptyState.classList.toggle('d-none', visible > 0);
                }
            };

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(btn => btn.classList.remove('active'));
                    tab.classList.add('active');
                    activeTab = tab.dataset.historyTab ?? 'all';
                    applyFilters();
                });
            });

            pageSizeSelect?.addEventListener('change', applyFilters);
            searchInput?.addEventListener('input', () => {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(applyFilters, 200);
            });

            applyFilters();
        })();
    </script>
}

<style>
    .history-card {
        border-radius: 24px;
        border: none;
    }

    .history-tabs .nav-link {
        border-radius: 999px;
        padding-inline: 18px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #475467;
    }

    .history-tabs .nav-link.active {
        background: #2563eb;
        color: #fff;
    }

    .history-card table tbody tr td {
        vertical-align: middle;
    }

    @@media (max-width: 767px) {
        .history-tabs {
            flex-wrap: wrap;
        }
    }
</style>
