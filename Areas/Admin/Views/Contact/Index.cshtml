@model KD_Restaurant.ViewModels.ContactAdminIndexViewModel
@using System.Linq

@{
    ViewData["Title"] = "Liên hệ khách hàng";
    var activeStatus = Model.StatusFilter?.ToLowerInvariant() ?? "unread";
}

<div class="pagetitle">
    <h1>Liên hệ khách hàng</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/admin/home">Dashboard</a></li>
            <li class="breadcrumb-item active">Liên hệ</li>
        </ol>
    </nav>
</div>

<section class="section dashboard">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card info-card sales-card">
                <div class="card-body">
                    <h5 class="card-title">Chưa đọc</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-warning text-white">
                            <i class="bi bi-envelope-exclamation"></i>
                        </div>
                        <div class="ps-3">
                            <h6>@Model.UnreadCount</h6>
                            <span class="text-muted small">Tin nhắn mới</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card info-card revenue-card">
                <div class="card-body">
                    <h5 class="card-title">Đã đọc</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-success text-white">
                            <i class="bi bi-chat-check"></i>
                        </div>
                        <div class="ps-3">
                            <h6>@Model.ReadCount</h6>
                            <span class="text-muted small">Đã phản hồi</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card info-card customers-card">
                <div class="card-body">
                    <h5 class="card-title">Tổng số</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-primary text-white">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="ps-3">
                            <h6>@Model.TotalCount</h6>
                            <span class="text-muted small">Liên hệ lưu trữ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 my-3">
                <form class="d-flex gap-2" method="get">
                    <input type="hidden" name="status" value="@activeStatus" />
                    <input type="search" class="form-control" name="search" placeholder="Tìm theo tên, email, điện thoại" value="@Model.Search" />
                    <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                </form>
                <div class="btn-group" role="group">
                    <form method="get">
                        <input type="hidden" name="search" value="@Model.Search" />
                        <button type="submit" name="status" value="unread" class="btn btn-outline-secondary @(activeStatus == "unread" ? "active" : string.Empty)">Chưa đọc (@Model.UnreadCount)</button>
                    </form>
                    <form method="get">
                        <input type="hidden" name="search" value="@Model.Search" />
                        <button type="submit" name="status" value="read" class="btn btn-outline-secondary @(activeStatus == "read" ? "active" : string.Empty)">Đã đọc (@Model.ReadCount)</button>
                    </form>
                    <form method="get">
                        <input type="hidden" name="search" value="@Model.Search" />
                        <button type="submit" name="status" value="all" class="btn btn-outline-secondary @(activeStatus == "all" ? "active" : string.Empty)">Tất cả (@Model.TotalCount)</button>
                    </form>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Khách hàng</th>
                            <th>Liên hệ</th>
                            <th>Nội dung</th>
                            <th>Thời gian</th>
                            <th class="text-end">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!Model.Contacts.Any())
                        {
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Không có liên hệ nào phù hợp.</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var contact in Model.Contacts)
                            {
                                <tr class="@(contact.IsRead ? string.Empty : "table-warning")">
                                    <td>
                                        <div class="fw-semibold">@contact.Name</div>
                                        <div class="small text-muted">@contact.Email</div>
                                    </td>
                                    <td>
                                        <div class="small"><i class="bi bi-telephone"></i> @contact.Phone</div>
                                        <div class="small text-muted">@(contact.IsRead ? "Đã đọc" : "Chưa đọc")</div>
                                    </td>
                                    <td class="small">@contact.Message</td>
                                    <td>
                                        <span class="small text-muted">@contact.CreatedDate?.ToString("dd/MM/yyyy HH:mm")</span>
                                    </td>
                                    <td class="text-end">
                                        <form asp-area="Admin" asp-controller="Contact" asp-action="ToggleRead" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@contact.Id" />
                                            <input type="hidden" name="status" value="@activeStatus" />
                                            <input type="hidden" name="search" value="@Model.Search" />
                                            <input type="hidden" name="page" value="@Model.CurrentPage" />
                                            <button type="submit" class="btn btn-sm @(contact.IsRead ? "btn-outline-warning" : "btn-outline-success") me-1">
                                                @(contact.IsRead ? "Đánh dấu chưa đọc" : "Đã xử lý")
                                            </button>
                                        </form>
                                        <form asp-area="Admin" asp-controller="Contact" asp-action="Delete" method="post" class="d-inline" onsubmit="return confirm('Bạn chắc chắn muốn xoá liên hệ này?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@contact.Id" />
                                            <input type="hidden" name="status" value="@activeStatus" />
                                            <input type="hidden" name="search" value="@Model.Search" />
                                            <input type="hidden" name="page" value="@Model.CurrentPage" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            @if (Model.TotalPages > 1)
            {
                <nav class="mt-3">
                    <ul class="pagination justify-content-end">
                        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : string.Empty)">
                            <a class="page-link" asp-area="Admin" asp-controller="Contact" asp-action="Index" asp-route-status="@activeStatus" asp-route-search="@Model.Search" asp-route-page="@(Model.CurrentPage - 1)">Trước</a>
                        </li>
                        @for (var i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(Model.CurrentPage == i ? "active" : string.Empty)">
                                <a class="page-link" asp-area="Admin" asp-controller="Contact" asp-action="Index" asp-route-status="@activeStatus" asp-route-search="@Model.Search" asp-route-page="@i">@i</a>
                            </li>
                        }
                        <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : string.Empty)">
                            <a class="page-link" asp-area="Admin" asp-controller="Contact" asp-action="Index" asp-route-status="@activeStatus" asp-route-search="@Model.Search" asp-route-page="@(Model.CurrentPage + 1)">Sau</a>
                        </li>
                    </ul>
                </nav>
            }
        </div>
    </div>
</section>
