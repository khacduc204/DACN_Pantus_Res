@model KD_Restaurant.ViewModels.MenuReviewAdminIndexViewModel
@using System.Linq
@{
    ViewData["Title"] = "Quản lý đánh giá món ăn";
    var activeStatus = Model.StatusFilter?.ToLowerInvariant() ?? "pending";
}

@section Styles {
    <style>
        .status-pill button.active {
            border-color: transparent;
            background: linear-gradient(120deg, #ffb347, #ffcc33);
            color: #3d2508;
            box-shadow: 0 8px 18px rgba(255, 179, 71, 0.35);
        }
    </style>
}

<div class="pagetitle">
    <h1 class="mb-1">Đánh giá món ăn</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/admin/home">Dashboard</a></li>
            <li class="breadcrumb-item active">Đánh giá món ăn</li>
        </ol>
    </nav>
</div>

<section class="section dashboard">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card info-card">
                <div class="card-body">
                    <h5 class="card-title">Chờ duyệt</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-warning text-white">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <div class="ps-3">
                            <h6>@Model.PendingCount</h6>
                            <span class="text-muted small">đánh giá chưa xuất bản</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card info-card">
                <div class="card-body">
                    <h5 class="card-title">Đã xuất bản</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-success text-white">
                            <i class="bi bi-check2-all"></i>
                        </div>
                        <div class="ps-3">
                            <h6>@Model.PublishedCount</h6>
                            <span class="text-muted small">đang hiển thị trên website</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card info-card">
                <div class="card-body">
                    <h5 class="card-title">Tổng cộng</h5>
                    <div class="d-flex align-items-center">
                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center bg-primary text-white">
                            <i class="bi bi-chat-heart"></i>
                        </div>
                        <div class="ps-3">
                            <h6>@Model.TotalCount</h6>
                            <span class="text-muted small">review được lưu trữ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="d-flex flex-column flex-xl-row align-items-xl-center justify-content-between gap-3 mb-3">
                <form class="d-flex gap-2" method="get">
                    <input type="hidden" name="status" value="@activeStatus" />
                    <input type="search" name="search" class="form-control" placeholder="Tìm theo khách, số điện thoại hoặc món ăn" value="@Model.Search" />
                    <button type="submit" class="btn btn-outline-secondary"><i class="bi bi-search"></i></button>
                </form>
                <div class="btn-group status-pill" role="group">
                    <form method="get">
                        <input type="hidden" name="search" value="@Model.Search" />
                        <button type="submit" name="status" value="pending" class="btn btn-outline-secondary @(activeStatus == "pending" ? "active" : string.Empty)">Chờ duyệt (@Model.PendingCount)</button>
                    </form>
                    <form method="get">
                        <input type="hidden" name="search" value="@Model.Search" />
                        <button type="submit" name="status" value="published" class="btn btn-outline-secondary @(activeStatus == "published" ? "active" : string.Empty)">Đã xuất bản (@Model.PublishedCount)</button>
                    </form>
                    <form method="get">
                        <input type="hidden" name="search" value="@Model.Search" />
                        <button type="submit" name="status" value="all" class="btn btn-outline-secondary @(activeStatus == "all" ? "active" : string.Empty)">Tất cả (@Model.TotalCount)</button>
                    </form>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Món ăn</th>
                            <th>Khách hàng</th>
                            <th>Điểm</th>
                            <th>Nội dung</th>
                            <th>Trạng thái</th>
                            <th class="text-end">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!Model.Reviews.Any())
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">Chưa có đánh giá phù hợp bộ lọc.</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var review in Model.Reviews)
                            {
                                <tr>
                                    <td>
                                        <div class="fw-semibold">@review.MenuTitle</div>
                                        <small class="text-muted">ID #@review.Id</small>
                                    </td>
                                    <td>
                                        <div>@review.ReviewerName</div>
                                        <small class="text-muted">@review.Phone</small>
                                    </td>
                                    <td>
                                        <div class="text-warning">
                                            @for (var star = 0; star < review.Rating; star++)
                                            {
                                                <i class="bi bi-star-fill"></i>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <small>@review.Detail</small>
                                    </td>
                                    <td>
                                        @if (review.IsActive)
                                        {
                                            <span class="badge bg-success">Đã xuất bản</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Chờ duyệt</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <form asp-area="Admin" asp-controller="MenuReview" asp-action="ToggleStatus" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@review.Id" />
                                            <input type="hidden" name="status" value="@activeStatus" />
                                            <input type="hidden" name="search" value="@Model.Search" />
                                            <input type="hidden" name="page" value="@Model.CurrentPage" />
                                            <button type="submit" class="btn btn-sm @(review.IsActive ? "btn-outline-warning" : "btn-outline-success") me-1">
                                                @(review.IsActive ? "Ẩn" : "Phê duyệt")
                                            </button>
                                        </form>
                                        <form asp-area="Admin" asp-controller="MenuReview" asp-action="Delete" method="post" class="d-inline" onsubmit="return confirm('Xóa đánh giá này?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@review.Id" />
                                            <input type="hidden" name="status" value="@activeStatus" />
                                            <input type="hidden" name="search" value="@Model.Search" />
                                            <input type="hidden" name="page" value="@Model.CurrentPage" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            @if (Model.TotalPages > 1)
            {
                <nav class="mt-3">
                    <ul class="pagination justify-content-end">
                        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : string.Empty)">
                            <a class="page-link" asp-area="Admin" asp-controller="MenuReview" asp-action="Index" asp-route-status="@activeStatus" asp-route-search="@Model.Search" asp-route-page="@(Model.CurrentPage - 1)">Trước</a>
                        </li>
                        @for (var i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(Model.CurrentPage == i ? "active" : string.Empty)">
                                <a class="page-link" asp-area="Admin" asp-controller="MenuReview" asp-action="Index" asp-route-status="@activeStatus" asp-route-search="@Model.Search" asp-route-page="@i">@i</a>
                            </li>
                        }
                        <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : string.Empty)">
                            <a class="page-link" asp-area="Admin" asp-controller="MenuReview" asp-action="Index" asp-route-status="@activeStatus" asp-route-search="@Model.Search" asp-route-page="@(Model.CurrentPage + 1)">Sau</a>
                        </li>
                    </ul>
                </nav>
            }
        </div>
    </div>
</section>
