@using KD_Restaurant.ViewModels
@model BookingInvoiceViewModel
@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Hoá đơn đặt bàn";
    var booking = Model.Booking ?? new BookingCardViewModel();
    var orderItems = Model.OrderItems ?? new List<BookingOrderItemViewModel>();
    var total = Model.OrderTotal;
    var autoPrint = (ViewBag.AutoPrint as bool?) ?? false;
    var timeInDisplay = Model.TimeIn?.ToString("dd/MM/yyyy HH:mm") ?? "—";
    var timeOutDisplay = Model.TimeOut?.ToString("dd/MM/yyyy HH:mm") ?? "—";
}

<div class="pagetitle">
    <h1>@ViewData["Title"]</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Home" asp-action="Index">Dashboard</a></li>
            <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Bookings" asp-action="Index">Lịch đặt bàn</a></li>
            <li class="breadcrumb-item active">Hoá đơn</li>
        </ol>
    </nav>
</div>

<section class="section">
    <div class="card invoice-card">
        <div class="card-body">
            <div class="d-flex justify-content-between flex-wrap gap-3 mb-4">
                <div>
                    <h3 class="mb-1">KD Restaurant</h3>
                    <div class="text-muted">Mã hoá đơn #INV-@booking.Id</div>
                </div>
                <div class="text-end">
                    <div class="fw-semibold">Ngày lập: @DateTime.Now.ToString("dd/MM/yyyy")</div>
                    <div class="text-muted">Bàn: @(booking.TableName ?? "Chưa xác định")</div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="invoice-block">
                        <div class="label">Khách hàng</div>
                        <div class="value">@booking.CustomerName</div>
                        <div class="text-muted">SĐT: @booking.CustomerPhone</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="invoice-block">
                        <div class="label">Thông tin đặt bàn</div>
                        <div class="value">@booking.BookingDate.ToString("dd/MM/yyyy") · Khung giờ @booking.TimeSlot</div>
                        <div class="text-muted">Số khách: @(booking.Guests ?? 0)</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="invoice-block">
                        <div class="label">Thời gian phục vụ</div>
                        <div class="value">Giờ vào: @timeInDisplay</div>
                        <div class="text-muted">Giờ ra: @timeOutDisplay</div>
                    </div>
                </div>
            </div>

            <div class="table-responsive mb-4">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Món</th>
                            <th class="text-center">Số lượng</th>
                            <th class="text-end">Đơn giá</th>
                            <th class="text-end">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (orderItems.Any())
                        {
                            foreach (var item in orderItems)
                            {
                                var unitPrice = item.Price ?? 0;
                                var lineTotal = unitPrice * item.Quantity;
                                <tr>
                                    <td>@item.ItemName</td>
                                    <td class="text-center">@item.Quantity</td>
                                    <td class="text-end">@unitPrice.ToString("N0") ₫</td>
                                    <td class="text-end">@lineTotal.ToString("N0") ₫</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">Chưa có món trong hoá đơn.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="payment-note">
                        <div class="label">Phương thức thanh toán</div>
                        <div class="value">@(!string.IsNullOrWhiteSpace(Model.PaymentMethod) ? Model.PaymentMethod : "Chưa cập nhật")</div>
                        <div class="text-muted">Thời gian: @(Model.PaymentTime?.ToString("dd/MM/yyyy HH:mm") ?? "—")</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="invoice-total text-end">
                        <div class="label">Tổng cộng</div>
                        <div class="amount">@total.ToString("N0") ₫</div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-outline-secondary" onclick="window.print()"><i class="bi bi-printer me-1"></i>In hoá đơn</button>
                <a class="btn btn-primary" asp-area="Admin" asp-controller="Bookings" asp-action="Index" asp-route-date="@booking.BookingDate.ToString("yyyy-MM-dd")">Quay lại danh sách</a>
            </div>
        </div>
    </div>
</section>

<style>
    .invoice-card {
        border-radius: 24px;
        border: none;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.12);
    }

    .invoice-block .label {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        color: #6b7280;
    }

    .invoice-block .value {
        font-weight: 600;
        font-size: 1.1rem;
        color: #111827;
    }

    .invoice-total .label {
        text-transform: uppercase;
        color: #6b7280;
        letter-spacing: 0.08em;
    }

    .invoice-total .amount {
        font-size: 2rem;
        font-weight: 700;
        color: #0f172a;
    }

    @@media print {
        .pagetitle, nav, .btn, a.btn {
            display: none !important;
        }

        body {
            background: #fff;
        }

        .invoice-card {
            box-shadow: none;
        }
    }
</style>

@section Scripts {
    <script>
        (() => {
            const autoPrint = @(autoPrint ? "true" : "false");
            if (autoPrint) {
                window.addEventListener('load', () => {
                    setTimeout(() => window.print(), 400);
                });
            }
        })();
    </script>
}
